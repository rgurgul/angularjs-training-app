const MODULES={MAIN:"myApp",THIRD_PARTY:{UI_ROUTER:"ui.router",UI_BOOTSTRAP:"ui.bootstrap",NG_RESOURCE:"ngResource",NG_COOKIES:"ngCookies",NG_FILE_UPLOAD:"ngFileUpload",NG_MESSAGES:"ngMessages",BREADCRUMB:"ncy-angular-breadcrumb",ASIDE_MENU:"jsonMenu",SANITIZE:"ngSanitize",NG_MAP:"ngMap"},VIEWS:{CONTACT:"myApp.contact",ITEMS:"myApp.items",ITEM_DETAILS:"myApp.itemDetails",SHOP:"myApp.shop",FAQ:"myApp.faq"},DIRECTIVES:{HEADER:"myApp.headerDctv",INPUT:"myApp.inputDctv",ITEM:"myApp.itemCmp",UPLOAD:"myApp.uploadDctv",SEARCH:"myApp.searchDctv",SORT:"myApp.sortDctv",LIST_DROP_DOWN:"myApp.listDropDownDctv"},SERVICES:{ITEMS_STORAGE:"myApp.itemsStorage",USER_STORAGE:"myApp.userStorage",MODAL_GENERATOR:"myApp.modalGenerator",API_INTERCEPTOR:"myApp.apiInterceptor"},FILTERS:{START_FROM:"myApp.filters"}},TEMPLATES={VIEWS:{CONTACT:"src/views/contact/contact.html",FAQ:"src/views/faq/faq-tpl.html",ITEM_DETAIL:"src/views/item-detail/item-detail.html",ITEMS:"src/views/items/items.html",SHOP:"src/views/shop/shop.html"},DIRECTIVES:{HEADER:"src/directives/header/header-tpl.html",INPUT:"src/directives/input/input-tpl.html",ITEM:"src/directives/item/item-tpl.html",UPLOAD:"src/directives/upload/upload-tpl.html",SORT:"src/directives/item/sort-tpl.html",SEARCH:"src/directives/search/search.html"},MODALS:{ADD_ITEM:"src/services/modal-tpls/modal-add-item.html",DELETE_ITEM:"src/services/modal-tpls/modal-delete-item.html",LOGIN:"src/services/modal-tpls/modal-login.html"}};
angular.module(MODULES.MAIN,[MODULES.THIRD_PARTY.BREADCRUMB,MODULES.THIRD_PARTY.ASIDE_MENU,MODULES.VIEWS.CONTACT,MODULES.VIEWS.ITEMS,MODULES.VIEWS.ITEM_DETAILS,MODULES.VIEWS.SHOP,MODULES.VIEWS.FAQ,MODULES.DIRECTIVES.HEADER,MODULES.SERVICES.USER_STORAGE,MODULES.SERVICES.API_INTERCEPTOR]).constant("CONFIG",{API_PREFIX:"http://js.edu.pl/api/"}).config(function($urlRouterProvider,$httpProvider){$httpProvider.defaults.withCredentials=!0,$urlRouterProvider.otherwise("/items"),$httpProvider.interceptors.push("apiInterceptor")}).run(function($rootScope,userStorage){$rootScope.$on("api:error",function(){userStorage.signOut()}),$rootScope.userState=userStorage.state,userStorage.checkUser(),$rootScope._=_});
angular.module(MODULES.FILTERS.START_FROM,[]).filter("startFromFtr",function(){return function(expression,currentPage,itemsPerPage){if(expression){var start=(currentPage-1)*itemsPerPage;return expression.slice(start)}}});
angular.module(MODULES.SERVICES.API_INTERCEPTOR,[]).service("apiInterceptor",function($q,$cookies,$rootScope){function errInfo(msg){alert(angular.toJson(msg)),$rootScope.$broadcast("api:error")}return{response:function(response){var defer=$q.defer(),isObj=angular.isObject(response.data);return isObj&&"OK"!==response.data.status?(errInfo(response),defer.reject(response)):defer.resolve(response),defer.promise},responseError:function(rejection){errInfo(rejection);var defer=$q.defer();return defer.reject(rejection),defer.promise}}});
angular.module(MODULES.SERVICES.ITEMS_STORAGE,[MODULES.THIRD_PARTY.NG_RESOURCE,MODULES.SERVICES.MODAL_GENERATOR]).service("itemsStorage",function($rootScope,$resource,modalGenerator,CONFIG){var api=$resource(CONFIG.API_PREFIX+"items/:id",{id:"@id"},{update:{method:"PUT"}}),itemsStorage={items:[],fetch:function(){api.get(function(responseData){itemsStorage.items.length=0,angular.extend(itemsStorage.items,responseData.data)})},get:function(item){api.get(item,function(responseData){itemsStorage.item=responseData.data})},add:function(){modalGenerator.open(TEMPLATES.MODALS.ADD_ITEM,"lm").then(function(modalData){api.save(modalData,function(responseData){itemsStorage.items.push(responseData.data)})})},update:function(item){$rootScope.userState.unsavedData=!0,api.update(item,function(){$rootScope.userState.unsavedData=!1})},"delete":function(item){modalGenerator.open(TEMPLATES.MODALS.DELETE_ITEM,"lm",item).then(function(modalData){api["delete"]({id:item.id},function(){itemsStorage.fetch(),alert("element: "+item.title+" został usunięty z powodu:\n"+modalData.reason)})})}};return itemsStorage});
angular.module(MODULES.SERVICES.MODAL_GENERATOR,[MODULES.THIRD_PARTY.UI_BOOTSTRAP,MODULES.DIRECTIVES.INPUT,MODULES.DIRECTIVES.UPLOAD]).service("modalGenerator",function($uibModal){return{open:function(tplUrl,size,model){var myModal=$uibModal.open({templateUrl:tplUrl,size:size,controller:function($scope){$scope.model=model||{},$scope.ok=function(valid){valid&&myModal.close($scope.model)},$scope.cancel=function(){myModal.dismiss("cancel")}}});return myModal.result}}});
angular.module(MODULES.SERVICES.USER_STORAGE,[MODULES.THIRD_PARTY.NG_COOKIES,MODULES.SERVICES.MODAL_GENERATOR]).service("userStorage",function($cookies,$http,modalGenerator,CONFIG){var userStorage={state:{access:!1,userName:!1,unsavedData:!1},setUserAccess:function(access,msg){this.state.access=access,access?$cookies.put("logged",access):$cookies.remove("logged"),msg&&alert(msg)},signIn:function(){modalGenerator.open(TEMPLATES.MODALS.LOGIN,"sm").then(function(modalData){$http.post(CONFIG.API_PREFIX+"login/",modalData).then(function(){userStorage.setUserAccess(!0,"zalogowano pomyślnie")})})},signOut:function(){$http.get(CONFIG.API_PREFIX+"logout/").then(function(){userStorage.setUserAccess(!1)})},checkUser:function(){$cookies.get("logged")?userStorage.setUserAccess(!0):userStorage.signIn()}};return userStorage});
angular.module(MODULES.DIRECTIVES.HEADER,[MODULES.SERVICES.ITEMS_STORAGE,MODULES.SERVICES.USER_STORAGE]).directive("headerDctv",function(itemsStorage,userStorage){return{transclude:!0,scope:!0,templateUrl:TEMPLATES.DIRECTIVES.HEADER,controller:function(){this.signIn=userStorage.signIn,this.signOut=userStorage.signOut,this.addItem=itemsStorage.add},controllerAs:"vm"}});
angular.module(MODULES.DIRECTIVES.INPUT,[MODULES.THIRD_PARTY.NG_MESSAGES]).directive("inputDctv",function(){return{transclude:!0,scope:{model:"="},require:"^form",templateUrl:TEMPLATES.DIRECTIVES.INPUT,compile:function(el,attrs){var tpl="multiline"===attrs.type?angular.element("<textarea>").attr("rows",4):angular.element("<input>").attr("type",attrs.type||"text");tpl.attr({"ng-required":attrs.required,"ng-minlength":attrs.minlength||3,"ng-model":"model"}),tpl.addClass("form-control");var inputContent=el[0].querySelector(".input-content");return angular.element(inputContent).append(tpl),{post:function(scope,el,attrs,form){scope.form=form}}}}});
angular.module(MODULES.DIRECTIVES.ITEM,[]).component("itemCmp",{bindings:{model:"<","delete":"&",update:"&"},templateUrl:TEMPLATES.DIRECTIVES.ITEM,controller:function($scope,$timeout){this.price=this.model.price,$scope.$watch("$ctrl.price",function(newVal,oldVal){angular.equals(newVal,oldVal)||($scope.$root.userState.unsavedData=!0,$timeout.cancel(this.timeoutId),this.timeoutId=$timeout(function(){this.model.price=this.price,this.update(this.model)}.bind(this),1e3))}.bind(this))}});
angular.module(MODULES.DIRECTIVES.SORT,[]).directive("sortDctv",function(){return{restrict:"A",transclude:!0,scope:{sortSettings:"=",sortCallback:"&"},templateUrl:TEMPLATES.DIRECTIVES.SORT,link:function(scope,el,attrs){scope.sortName=attrs.sortDctv,scope.sortSettings.sortName===scope.sortName&&(scope.sortSettings.sortBy=scope.sortName),scope.sorting=function(){scope.sortSettings.sortBy=scope.sortName,scope.sortSettings.desc=scope.sortSettings.sortBy===scope.sortName&&!scope.sortSettings.desc,scope.sortSettings.sortBy=scope.sortName,scope.sortCallback&&scope.sortCallback()}}}});
angular.module(MODULES.DIRECTIVES.SEARCH,[]).component("searchDctv",{templateUrl:TEMPLATES.DIRECTIVES.SEARCH,bindings:{control:"<",items:"<"}});
angular.module(MODULES.DIRECTIVES.LIST_DROP_DOWN,[]).directive("listDropDownDctv",function(){return{controller:function(){this.current=void 0}}}).directive("itemDropDownDctv",function(){return{scope:!0,require:"^listDropDownDctv",link:function($scope,element,attrs,listDropDownCtrl){$scope.setActive=function(item){listDropDownCtrl.current?listDropDownCtrl.current===item?item.active=!item.active:(listDropDownCtrl.current.active=!1,item.active=!0,listDropDownCtrl.current=item):(item.active=!0,listDropDownCtrl.current=item)}}}});
angular.module(MODULES.DIRECTIVES.UPLOAD,[MODULES.THIRD_PARTY.NG_FILE_UPLOAD]).component("uploadDctv",{bindings:{model:"=",required:"<"},require:{form:"^form"},templateUrl:TEMPLATES.DIRECTIVES.UPLOAD,controller:function(Upload,CONFIG){var self=this;this.file$=new Rx.Subject,this.file$.subscribe(function(file){Upload.upload({url:CONFIG.API_PREFIX+"file.php",file:file}).progress(function(evt){self.percent=(evt.loaded/evt.total*100).toFixed()}).success(function(data){self.model=data.file})})}});
angular.module(MODULES.VIEWS.CONTACT,[MODULES.THIRD_PARTY.UI_ROUTER,MODULES.DIRECTIVES.INPUT]).config(function($stateProvider){$stateProvider.state("contact",{url:"/contact",templateUrl:TEMPLATES.VIEWS.CONTACT,controller:"ContactCtrl",ncyBreadcrumb:{label:"Kontakt"}})}).controller("ContactCtrl",function($scope){$scope.sendForm=function(){$scope.contactForm.$valid&&($scope.formSent=!0,$scope.contactForm.$setPristine(),$scope.user={})}});
angular.module(MODULES.VIEWS.FAQ,[MODULES.THIRD_PARTY.UI_ROUTER,MODULES.THIRD_PARTY.SANITIZE,MODULES.DIRECTIVES.LIST_DROP_DOWN]).config(function($stateProvider){$stateProvider.state("faq",{url:"/faq",templateUrl:TEMPLATES.VIEWS.FAQ,controller:"FaqCtrl",ncyBreadcrumb:{label:"Faq"}})}).controller("FaqCtrl",function($scope,$http,CONFIG){$http.get(CONFIG.API_PREFIX+"faq.json").success(function(data){$scope.items=data.responseData.feed.entries,$scope.currentPage=1,$scope.itemsPerPage=10,$scope.maxSize=5})});
angular.module(MODULES.VIEWS.ITEM_DETAILS,[MODULES.THIRD_PARTY.UI_ROUTER,MODULES.SERVICES.ITEMS_STORAGE,MODULES.DIRECTIVES.UPLOAD]).config(function($stateProvider){$stateProvider.state("item-details",{url:"/item-details",template:"<ui-view></ui-view>",ncyBreadcrumb:{label:"produkt"}}).state("item-details.item",{url:"/:id",templateUrl:TEMPLATES.VIEWS.ITEM_DETAIL,controller:"ItemDetailCtrl",ncyBreadcrumb:{label:"{{data.title | limitTo : 50}}{{(data.title.length > 50) && '...' || ''}}"},resolve:{responseData:function(itemsStorage,$stateParams){itemsStorage.get({id:$stateParams.id})}}})}).controller("ItemDetailCtrl",function($scope,itemsStorage){$scope.itemsStorage=itemsStorage,$scope.update=function(){itemsStorage.update($scope.itemsStorage.item)}});
angular.module(MODULES.VIEWS.SHOP,[MODULES.THIRD_PARTY.UI_ROUTER,MODULES.THIRD_PARTY.UI_BOOTSTRAP,MODULES.THIRD_PARTY.NG_MAP]).config(function($stateProvider){$stateProvider.state("shops",{url:"/shops/:id",templateUrl:TEMPLATES.VIEWS.SHOP,controller:"ShopCtrl",ncyBreadcrumb:{label:"{{shopName}}"}})}).controller("ShopCtrl",function($scope,$state,$http,CONFIG){function setMarker(data){var marker=new google.maps.Marker;$scope.$on("$destroy",function(){marker.setMap(null)});var lat=data.position.lat,lng=data.position.lng,loc=new google.maps.LatLng(lat,lng);marker.setPosition(loc),marker.setMap($scope.map)}$scope.$on("mapInitialized",function(evt,evtMap){$http.get(CONFIG.API_PREFIX+"shop"+$state.params.id+".json").success(function(responseData){$scope.shopName=responseData.data.name,$scope.data=responseData.data,$scope.map.setZoom(6),$scope.map.setOptions({draggable:!1,zoomControl:!0,scrollwheel:!0,disableDoubleClickZoom:!0}),setMarker($scope.data)})})});
angular.module(MODULES.VIEWS.ITEMS,[MODULES.THIRD_PARTY.UI_ROUTER,MODULES.DIRECTIVES.SORT,MODULES.DIRECTIVES.ITEM,MODULES.SERVICES.ITEMS_STORAGE,MODULES.FILTERS.START_FROM,MODULES.DIRECTIVES.SEARCH]).config(function($stateProvider){$stateProvider.state("items",{url:"/items",templateUrl:TEMPLATES.VIEWS.ITEMS,controller:"ItemsCtrl",controllerAs:"vm",ncyBreadcrumb:{label:"Produkty"}})}).controller("ItemsCtrl",function(itemsStorage){itemsStorage.fetch(),this.items=itemsStorage.items,this["delete"]=itemsStorage["delete"],this.update=itemsStorage.update,this.itemsControl={currentPage:1,itemsPerPage:5}});